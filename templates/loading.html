<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YomuTomo - AIå¤„ç†ä¸­...</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
    <link rel="alternate icon" href="/static/favicon.ico" />
    <link rel="stylesheet" href="/static/css/new_style.css" />
  </head>
  <body>
    <div class="container">
      <nav class="nav-bar">
        <a href="/" class="nav-button">ğŸ  å›åˆ°é¦–é¡µ</a>
      </nav>

      <header class="page-header">
        <h1>ğŸ¤– AIå¤„ç†ä¸­...</h1>
        <p>æ­£åœ¨å¹¶å‘ç”Ÿæˆæ³¨éŸ³ã€è¯æ±‡ã€ç¿»è¯‘ç­‰å†…å®¹ï¼Œè¯·ç¨å€™</p>
      </header>

      <main class="main-content">
        <section class="card loading-card">
          <div class="loading-container">
            <div class="loading-spinner"></div>
            <h2>ğŸš€ å¤šçº¿ç¨‹AIå¤„ç†ä¸­</h2>
            <p>æ­£åœ¨å¹¶å‘æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š</p>
            <div class="loading-tasks">
              <div class="task-item">
                <span class="task-icon">ğŸ“</span>
                <span class="task-text">ç”Ÿæˆæ³¨éŸ³æ ‡è®°</span>
                <div class="task-progress">
                  <div class="progress-bar"></div>
                </div>
              </div>
              <div class="task-item">
                <span class="task-icon">ğŸ“š</span>
                <span class="task-text">æå–ç”Ÿè¯åˆ—è¡¨</span>
                <div class="task-progress">
                  <div class="progress-bar"></div>
                </div>
              </div>
              <div class="task-item">
                <span class="task-icon">ğŸ‡¨ğŸ‡³</span>
                <span class="task-text">ç”Ÿæˆä¸­æ–‡ç¿»è¯‘</span>
                <div class="task-progress">
                  <div class="progress-bar"></div>
                </div>
              </div>
              <div class="task-item">
                <span class="task-icon">ğŸ·ï¸</span>
                <span class="task-text">ç”Ÿæˆæ–‡ç« æ ‡é¢˜</span>
                <div class="task-progress">
                  <div class="progress-bar"></div>
                </div>
              </div>
              <div class="task-item">
                <span class="task-icon">ğŸ˜Š</span>
                <span class="task-text">ç”Ÿæˆå°é¢è¡¨æƒ…</span>
                <div class="task-progress">
                  <div class="progress-bar"></div>
                </div>
              </div>
            </div>
            <div class="loading-message">
              <p>ğŸ’¡ æç¤ºï¼šå¤šçº¿ç¨‹å¹¶å‘å¤„ç†ï¼Œé¢„è®¡éœ€è¦ 10-300 ç§’</p>
              <p>âš¡ è´¨é‡ä¼˜å…ˆï¼Œè€å¿ƒç­‰å¾…</p>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      // æ¨¡æ‹Ÿè¿›åº¦æ¡åŠ¨ç”»
      document.addEventListener('DOMContentLoaded', function() {
        const progressBars = document.querySelectorAll('.progress-bar');

        progressBars.forEach((bar, index) => {
          // éšæœºå»¶è¿Ÿå¼€å§‹åŠ¨ç”»
          setTimeout(() => {
            bar.style.width = '100%';
          }, index * 500);
        });

        // å¼€å§‹å¼‚æ­¥å¤„ç†
        startProcessing();
      });

      async function startProcessing() {
        try {
          // è·å–è¡¨å•æ•°æ®ï¼ˆä»sessionStorageæˆ–localStorageä¸­è·å–ï¼‰
          const formData = new FormData();
          const text = sessionStorage.getItem('processing_text');
          const model = sessionStorage.getItem('processing_model');

          if (!text) {
            alert('æ²¡æœ‰æ‰¾åˆ°è¦å¤„ç†çš„æ–‡æœ¬ï¼Œè¯·é‡æ–°æäº¤');
            window.location.href = '/';
            return;
          }

          formData.append('text', text);
          if (model) {
            formData.append('model', model);
          }

          // è°ƒç”¨å¼‚æ­¥å¤„ç†API
          const response = await fetch('/process_text_async', {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.error) {
            alert('å¤„ç†å¤±è´¥: ' + result.error);
            window.location.href = '/';
            return;
          }

          // å¤„ç†æˆåŠŸï¼Œé‡å®šå‘åˆ°ç»“æœé¡µé¢
          if (result.redirect_url) {
            window.location.href = result.redirect_url;
          } else {
            // å¦‚æœæ²¡æœ‰é‡å®šå‘URLï¼Œè¯´æ˜æ˜¯æœªç™»å½•ç”¨æˆ·ï¼Œç›´æ¥æ˜¾ç¤ºç»“æœ
            sessionStorage.setItem('processed_result', JSON.stringify(result));
            window.location.href = '/reading_result';
          }

        } catch (error) {
          console.error('å¤„ç†å¤±è´¥:', error);
          alert('å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
          window.location.href = '/';
        }
      }
    </script>
  </body>
</html>
