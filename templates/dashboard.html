<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YomuTomo-æˆ‘çš„æ–‡ç« </title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
    <link rel="alternate icon" href="/static/favicon.ico" />
    <link rel="stylesheet" href="/static/css/main.css" />
  </head>
  <body>
    <div class="container">
      <nav class="nav-bar">
        {% if user %}<span class="user-pill">ğŸ‘‹ {{ user.email }}</span>{% endif %}
        <a href="/" class="nav-button">ğŸ  é¦–é¡µ</a>
        <a href="/dashboard" class="nav-button">ğŸ“š æˆ‘çš„æ–‡ç« </a>
        <form method="post" action="/logout">
          <button type="submit" class="nav-button">ğŸšª é€€å‡ºç™»å½•</button>
        </form>
      </nav>
      <header class="page-header">
        <h1>ğŸ—‚ï¸ æˆ‘çš„æ–‡ç« </h1>
        <p>æŒ‰æœ€è¿‘æ›´æ–°æ’åºã€‚</p>
      </header>
      <main class="main-content">
        <section class="card">
          <h2 style="margin-bottom:16px;">å·²ä¿å­˜</h2>
          {% if articles and articles|length > 0 %}
          <div class="article-grid">
            {% for a in articles %}
            <div class="article-bubble" data-article-id="{{ a.id }}" data-title="{{ a.title | replace('"',' ') | replace('\'',' ') }}">
              <div class="bubble-main" data-article-id="{{ a.id }}" title="æ‰“å¼€æ–‡ç« ">
                <div class="bubble-emoji">{{ a.emoji_cover or "ğŸ“" }}</div>
                <div class="bubble-title" title="{{ a.title }}">{{ a.title }}</div>
                <div class="bubble-meta">æ›´æ–°ï¼š{{ a.updated_at_beijing.strftime('%Y-%m-%d %H:%M:%S') if a.updated_at_beijing else '' }}</div>
              </div>
              <button class="bubble-menu-btn" data-article-id="{{ a.id }}" aria-label="æ›´å¤šæ“ä½œ">â‹¯</button>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p>è¿˜æ²¡æœ‰ä¿å­˜çš„æ–‡ç« ã€‚å›åˆ°é¦–é¡µç²˜è´´æ–‡æœ¬åå¼€å§‹ç”Ÿæˆå§ã€‚</p>
          {% endif %}
        </section>
        {% if total_pages and total_pages > 1 %}
        <nav class="pagination">
          {% set base = '/dashboard?size=' ~ size ~ '&page=' %}
          {% set prev_page = page-1 if page>1 else 1 %}
          {% set next_page = page+1 if page<total_pages else total_pages %}
          <a href="{{ base ~ prev_page }}" class="nav-button pagination-btn {% if page==1 %}disabled{% endif %}" style="padding:6px 14px;">ä¸Šä¸€é¡µ</a>
          <span class="pagination-info">ç¬¬ {{ page }} / {{ total_pages }} é¡µï¼ˆå…± {{ total_items }} ç¯‡ï¼‰</span>
          <a href="{{ base ~ next_page }}" class="nav-button pagination-btn {% if page==total_pages %}disabled{% endif %}" style="padding:6px 14px;">ä¸‹ä¸€é¡µ</a>
        </nav>
        {% endif %}
      </main>
    </div>
    <div id="action-panel-overlay" class="action-overlay" style="display:none;">
      <div class="action-panel">
        <div class="action-header">
          <span id="ap-emoji">ğŸ“</span>
          <span id="ap-title" class="ap-title">æ ‡é¢˜</span>
          <button class="ap-close" onclick="closeActionPanel()">âœ•</button>
        </div>
        <form id="rename-form" method="post" class="ap-row">
          <input type="text" name="title" id="ap-input" placeholder="æ–°æ ‡é¢˜" />
          <button type="submit" class="btn-primary" style="white-space:nowrap;">ä¿å­˜</button>
        </form>
        <form id="delete-form" method="post" onsubmit="return confirm('ç¡®å®šåˆ é™¤è¯¥æ–‡ç« å—ï¼Ÿ');" class="ap-row">
          <button type="submit" class="btn-danger" style="width:100%;">åˆ é™¤æ–‡ç« </button>
        </form>
      </div>
    </div>
    <script>
      function openArticle(id){ window.location.href = '/articles/' + id }
      function showActionPanelFromBubble(bubble){
        const id = bubble.dataset.articleId;
        const emoji = bubble.querySelector('.bubble-emoji').textContent.trim() || 'ğŸ“';
        const title = bubble.dataset.title || 'æ ‡é¢˜';
        const overlay = document.getElementById('action-panel-overlay');
        document.getElementById('ap-emoji').textContent = emoji;
        document.getElementById('ap-title').textContent = title;
        const renameForm = document.getElementById('rename-form');
        const deleteForm = document.getElementById('delete-form');
        renameForm.action = '/articles/' + id + '/rename';
        deleteForm.action = '/articles/' + id + '/delete';
        document.getElementById('ap-input').value = title;
        overlay.style.display='flex';
        setTimeout(()=>overlay.classList.add('show'),10);
      }
      function closeActionPanel(){
        const overlay = document.getElementById('action-panel-overlay');
        overlay.classList.remove('show');
        setTimeout(()=>overlay.style.display='none',200);
      }
      document.addEventListener('click', (e)=>{
        const overlay = document.getElementById('action-panel-overlay');
        const menuBtn = e.target.closest('.bubble-menu-btn');
        const bubbleMain = e.target.closest('.bubble-main');
        if(menuBtn){
          e.stopPropagation();
          const bubble = menuBtn.closest('.article-bubble');
          showActionPanelFromBubble(bubble);
          return;
        }
        if(bubbleMain){
          const id = bubbleMain.dataset.articleId;
          if(id) openArticle(id);
          return;
        }
        if(overlay.style.display==='flex' && !e.target.closest('.action-panel')){
          closeActionPanel();
        }
      });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeActionPanel(); });
    </script>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
    <button id="back-to-top" class="back-to-top-btn" title="å›åˆ°é¡¶éƒ¨">
      <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2L13.5 7H19L14.5 10.5L16 15.5L12 12.5L8 15.5L9.5 10.5L5 7H10.5L12 2Z" fill="currentColor"/>
        <path d="M10 19L12 16L14 19" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <script src="/static/js/modules/ai-config.js"></script>
    <script src="/static/js/modules/speech-recognition.js"></script>
    <script src="/static/js/modules/text-highlight.js"></script>
    <script src="/static/js/modules/pdf-export.js"></script>
    <script src="/static/js/common.js"></script>
    <script src="/static/js/new_script.js"></script>
  </body>
</html>
