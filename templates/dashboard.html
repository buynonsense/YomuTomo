<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>我的文章</title>
    <link rel="stylesheet" href="/static/css/new_style.css" />
  </head>
  <body>
    <div class="container">
      <nav class="nav-bar">
        <a href="/" class="nav-button">🏠 首页</a>
        <form method="post" action="/logout" style="display: inline">
          <button type="submit" class="nav-button">🚪 退出登录</button>
        </form>
      </nav>
      <header class="page-header">
        <h1>🗂️ 我的文章</h1>
        <p>按最近更新排序。打开文章会自动刷新它的更新时间。</p>
      </header>
      <main class="main-content">
        <section class="card">
          <h2 style="margin-bottom:16px;">已保存</h2>
          {% if articles and articles|length > 0 %}
          <div class="article-grid">
            {% for a in articles %}
            <div class="article-bubble" data-article-id="{{ a.id }}" data-title="{{ a.title | replace('"',' ') | replace('\'',' ') }}">
              <div class="bubble-main" onclick="openArticle({{ a.id }})" title="打开文章">
                <div class="bubble-emoji">{{ a.emoji_cover or "📝" }}</div>
                <div class="bubble-title" title="{{ a.title }}">{{ a.title }}</div>
                <div class="bubble-meta">更新：{{ a.updated_at|string|slice(0,19) }}</div>
              </div>
              <button class="bubble-menu-btn" onclick="showActionPanel(event, {{ a.id }})" aria-label="更多操作">⋯</button>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p>还没有保存的文章。回到首页粘贴文本后开始生成吧。</p>
          {% endif %}
        </section>
      </main>
    </div>
    <div id="action-panel-overlay" class="action-overlay" style="display:none;">
      <div class="action-panel">
        <div class="action-header">
          <span id="ap-emoji">📝</span>
          <span id="ap-title" class="ap-title">标题</span>
          <button class="ap-close" onclick="closeActionPanel()">✕</button>
        </div>
        <form id="rename-form" method="post" class="ap-row">
          <input type="text" name="title" id="ap-input" placeholder="新标题" />
          <button type="submit" class="btn-primary" style="white-space:nowrap;">保存</button>
        </form>
        <form id="delete-form" method="post" onsubmit="return confirm('确定删除该文章吗？');" class="ap-row">
          <button type="submit" class="btn-danger" style="width:100%;">删除文章</button>
        </form>
      </div>
    </div>
    <script>
      function openArticle(id){ window.location.href = '/articles/' + id }
      function showActionPanel(e,id){
        e.stopPropagation();
        const bubble = e.currentTarget.closest('.article-bubble');
        const emoji = bubble.querySelector('.bubble-emoji').textContent.trim() || '📝';
        const title = bubble.dataset.title || '标题';
        const overlay = document.getElementById('action-panel-overlay');
        document.getElementById('ap-emoji').textContent = emoji;
        document.getElementById('ap-title').textContent = title;
        const renameForm = document.getElementById('rename-form');
        const deleteForm = document.getElementById('delete-form');
        renameForm.action = '/articles/' + id + '/rename';
        deleteForm.action = '/articles/' + id + '/delete';
        document.getElementById('ap-input').value = title;
        overlay.style.display='flex';
        setTimeout(()=>overlay.classList.add('show'),10);
      }
      function closeActionPanel(){
        const overlay = document.getElementById('action-panel-overlay');
        overlay.classList.remove('show');
        setTimeout(()=>overlay.style.display='none',200);
      }
      document.addEventListener('click', (e)=>{
        const overlay = document.getElementById('action-panel-overlay');
        if(overlay.style.display==='flex' && !e.target.closest('.action-panel') && !e.target.closest('.bubble-menu-btn')){
          closeActionPanel();
        }
      });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeActionPanel(); });
    </script>
  </body>
</html>
