<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æˆ‘çš„æ–‡ç« </title>
    <link rel="stylesheet" href="/static/css/new_style.css" />
  </head>
  <body>
    <div class="container">
      <style>
        .pagination { margin-top:24px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
        .pagination-btn.disabled { opacity:.5; pointer-events:none; }
        .pagination-info { color:#fff; font-size:14px; }
      </style>
      <nav class="nav-bar">
        <a href="/" class="nav-button">ğŸ  é¦–é¡µ</a>
        <form method="post" action="/logout" style="display: inline">
          <button type="submit" class="nav-button">ğŸšª é€€å‡ºç™»å½•</button>
        </form>
      </nav>
      <header class="page-header">
        <h1>ğŸ—‚ï¸ æˆ‘çš„æ–‡ç« </h1>
        <p>æŒ‰æœ€è¿‘æ›´æ–°æ’åºã€‚æ‰“å¼€æ–‡ç« ä¼šè‡ªåŠ¨åˆ·æ–°å®ƒçš„æ›´æ–°æ—¶é—´ã€‚</p>
      </header>
      <main class="main-content">
        <section class="card">
          <h2 style="margin-bottom:16px;">å·²ä¿å­˜</h2>
          {% if articles and articles|length > 0 %}
          <div class="article-grid">
            {% for a in articles %}
            <div class="article-bubble" data-article-id="{{ a.id }}" data-title="{{ a.title | replace('"',' ') | replace('\'',' ') }}">
              <div class="bubble-main" data-article-id="{{ a.id }}" title="æ‰“å¼€æ–‡ç« ">
                <div class="bubble-emoji">{{ a.emoji_cover or "ğŸ“" }}</div>
                <div class="bubble-title" title="{{ a.title }}">{{ a.title }}</div>
                <div class="bubble-meta">æ›´æ–°ï¼š{{ a.updated_at.strftime('%Y-%m-%d %H:%M:%S') if a.updated_at else '' }}</div>
              </div>
              <button class="bubble-menu-btn" data-article-id="{{ a.id }}" aria-label="æ›´å¤šæ“ä½œ">â‹¯</button>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p>è¿˜æ²¡æœ‰ä¿å­˜çš„æ–‡ç« ã€‚å›åˆ°é¦–é¡µç²˜è´´æ–‡æœ¬åå¼€å§‹ç”Ÿæˆå§ã€‚</p>
          {% endif %}
        </section>
        {% if total_pages and total_pages > 1 %}
        <nav class="pagination">
          {% set base = '/dashboard?size=' ~ size ~ '&page=' %}
          {% set prev_page = page-1 if page>1 else 1 %}
          {% set next_page = page+1 if page<total_pages else total_pages %}
          <a href="{{ base ~ prev_page }}" class="nav-button pagination-btn {% if page==1 %}disabled{% endif %}" style="padding:6px 14px;">ä¸Šä¸€é¡µ</a>
          <span class="pagination-info">ç¬¬ {{ page }} / {{ total_pages }} é¡µï¼ˆå…± {{ total_items }} ç¯‡ï¼‰</span>
          <a href="{{ base ~ next_page }}" class="nav-button pagination-btn {% if page==total_pages %}disabled{% endif %}" style="padding:6px 14px;">ä¸‹ä¸€é¡µ</a>
        </nav>
        {% endif %}
      </main>
    </div>
    <div id="action-panel-overlay" class="action-overlay" style="display:none;">
      <div class="action-panel">
        <div class="action-header">
          <span id="ap-emoji">ğŸ“</span>
          <span id="ap-title" class="ap-title">æ ‡é¢˜</span>
          <button class="ap-close" onclick="closeActionPanel()">âœ•</button>
        </div>
        <form id="rename-form" method="post" class="ap-row">
          <input type="text" name="title" id="ap-input" placeholder="æ–°æ ‡é¢˜" />
          <button type="submit" class="btn-primary" style="white-space:nowrap;">ä¿å­˜</button>
        </form>
        <form id="delete-form" method="post" onsubmit="return confirm('ç¡®å®šåˆ é™¤è¯¥æ–‡ç« å—ï¼Ÿ');" class="ap-row">
          <button type="submit" class="btn-danger" style="width:100%;">åˆ é™¤æ–‡ç« </button>
        </form>
      </div>
    </div>
    <script>
      function openArticle(id){ window.location.href = '/articles/' + id }
      function showActionPanelFromBubble(bubble){
        const id = bubble.dataset.articleId;
        const emoji = bubble.querySelector('.bubble-emoji').textContent.trim() || 'ğŸ“';
        const title = bubble.dataset.title || 'æ ‡é¢˜';
        const overlay = document.getElementById('action-panel-overlay');
        document.getElementById('ap-emoji').textContent = emoji;
        document.getElementById('ap-title').textContent = title;
        const renameForm = document.getElementById('rename-form');
        const deleteForm = document.getElementById('delete-form');
        renameForm.action = '/articles/' + id + '/rename';
        deleteForm.action = '/articles/' + id + '/delete';
        document.getElementById('ap-input').value = title;
        overlay.style.display='flex';
        setTimeout(()=>overlay.classList.add('show'),10);
      }
      function closeActionPanel(){
        const overlay = document.getElementById('action-panel-overlay');
        overlay.classList.remove('show');
        setTimeout(()=>overlay.style.display='none',200);
      }
      document.addEventListener('click', (e)=>{
        const overlay = document.getElementById('action-panel-overlay');
        const menuBtn = e.target.closest('.bubble-menu-btn');
        const bubbleMain = e.target.closest('.bubble-main');
        if(menuBtn){
          e.stopPropagation();
          const bubble = menuBtn.closest('.article-bubble');
          showActionPanelFromBubble(bubble);
          return;
        }
        if(bubbleMain){
          const id = bubbleMain.dataset.articleId;
          if(id) openArticle(id);
          return;
        }
        if(overlay.style.display==='flex' && !e.target.closest('.action-panel')){
          closeActionPanel();
        }
      });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeActionPanel(); });
    </script>
  </body>
</html>
