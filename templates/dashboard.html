<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YomuTomo-我的文章</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
    <link rel="alternate icon" href="/static/favicon.ico" />
    <link rel="stylesheet" href="/static/css/main.css" />
  </head>
  <body>
    <div class="container">
      <nav class="nav-bar">
        {% if user %}<span class="user-pill">👋 {{ user.email }}</span>{% endif %}
        <a href="/" class="nav-button">🏠 首页</a>
        <a href="/dashboard" class="nav-button">📚 我的文章</a>
        <form method="post" action="/logout">
          <button type="submit" class="nav-button">🚪 退出登录</button>
        </form>
      </nav>
      <header class="page-header">
        <h1>🗂️ 我的文章</h1>
        <p>按最近更新排序。</p>
      </header>
      <main class="main-content">
        <section class="card">
          <h2 style="margin-bottom:16px;">已保存</h2>
          {% if articles and articles|length > 0 %}
          <div class="article-grid">
            {% for a in articles %}
            <div class="article-bubble" data-article-id="{{ a.id }}" data-title="{{ a.title | replace('"',' ') | replace('\'',' ') }}">
              <div class="bubble-main" data-article-id="{{ a.id }}" title="打开文章">
                <div class="bubble-emoji">{{ a.emoji_cover or "📝" }}</div>
                <div class="bubble-title" title="{{ a.title }}">{{ a.title }}</div>
                <div class="bubble-meta">更新：{{ a.updated_at_beijing.strftime('%Y-%m-%d %H:%M:%S') if a.updated_at_beijing else '' }}</div>
              </div>
              <button class="bubble-menu-btn" data-article-id="{{ a.id }}" aria-label="更多操作">⋯</button>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p>还没有保存的文章。回到首页粘贴文本后开始生成吧。</p>
          {% endif %}
        </section>
        {% if total_pages and total_pages > 1 %}
        <nav class="pagination">
          {% set base = '/dashboard?size=' ~ size ~ '&page=' %}
          {% set prev_page = page-1 if page>1 else 1 %}
          {% set next_page = page+1 if page<total_pages else total_pages %}
          <a href="{{ base ~ prev_page }}" class="nav-button pagination-btn {% if page==1 %}disabled{% endif %}" style="padding:6px 14px;">上一页</a>
          <span class="pagination-info">第 {{ page }} / {{ total_pages }} 页（共 {{ total_items }} 篇）</span>
          <a href="{{ base ~ next_page }}" class="nav-button pagination-btn {% if page==total_pages %}disabled{% endif %}" style="padding:6px 14px;">下一页</a>
        </nav>
        {% endif %}
      </main>
    </div>
    <div id="action-panel-overlay" class="action-overlay" style="display:none;">
      <div class="action-panel">
        <div class="action-header">
          <span id="ap-emoji">📝</span>
          <span id="ap-title" class="ap-title">标题</span>
          <button class="ap-close" onclick="closeActionPanel()">✕</button>
        </div>
        <form id="rename-form" method="post" class="ap-row">
          <input type="text" name="title" id="ap-input" placeholder="新标题" />
          <button type="submit" class="btn-primary" style="white-space:nowrap;">保存</button>
        </form>
        <form id="delete-form" method="post" onsubmit="return confirm('确定删除该文章吗？');" class="ap-row">
          <button type="submit" class="btn-danger" style="width:100%;">删除文章</button>
        </form>
      </div>
    </div>
    <script>
      function openArticle(id){ window.location.href = '/articles/' + id }
      function showActionPanelFromBubble(bubble){
        const id = bubble.dataset.articleId;
        const emoji = bubble.querySelector('.bubble-emoji').textContent.trim() || '📝';
        const title = bubble.dataset.title || '标题';
        const overlay = document.getElementById('action-panel-overlay');
        document.getElementById('ap-emoji').textContent = emoji;
        document.getElementById('ap-title').textContent = title;
        const renameForm = document.getElementById('rename-form');
        const deleteForm = document.getElementById('delete-form');
        renameForm.action = '/articles/' + id + '/rename';
        deleteForm.action = '/articles/' + id + '/delete';
        document.getElementById('ap-input').value = title;
        overlay.style.display='flex';
        setTimeout(()=>overlay.classList.add('show'),10);
      }
      function closeActionPanel(){
        const overlay = document.getElementById('action-panel-overlay');
        overlay.classList.remove('show');
        setTimeout(()=>overlay.style.display='none',200);
      }
      document.addEventListener('click', (e)=>{
        const overlay = document.getElementById('action-panel-overlay');
        const menuBtn = e.target.closest('.bubble-menu-btn');
        const bubbleMain = e.target.closest('.bubble-main');
        if(menuBtn){
          e.stopPropagation();
          const bubble = menuBtn.closest('.article-bubble');
          showActionPanelFromBubble(bubble);
          return;
        }
        if(bubbleMain){
          const id = bubbleMain.dataset.articleId;
          if(id) openArticle(id);
          return;
        }
        if(overlay.style.display==='flex' && !e.target.closest('.action-panel')){
          closeActionPanel();
        }
      });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeActionPanel(); });
    </script>

    <!-- 回到顶部按钮 -->
    <button id="back-to-top" class="back-to-top-btn" title="回到顶部">
      <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2L13.5 7H19L14.5 10.5L16 15.5L12 12.5L8 15.5L9.5 10.5L5 7H10.5L12 2Z" fill="currentColor"/>
        <path d="M10 19L12 16L14 19" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <script src="/static/js/modules/ai-config.js"></script>
    <script src="/static/js/modules/speech-recognition.js"></script>
    <script src="/static/js/modules/text-highlight.js"></script>
    <script src="/static/js/modules/pdf-export.js"></script>
    <script src="/static/js/common.js"></script>
    <script src="/static/js/new_script.js"></script>
  </body>
</html>
